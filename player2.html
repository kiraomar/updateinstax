<script>

const urlParams = new URLSearchParams(window.location.search);
const streamUrl = urlParams.get('url');
const video = document.getElementById('video');
const loading = document.getElementById('loading-spinner');
const errorMsg = document.getElementById('error-msg');

// ๐ฅ ุฑุงุจุท ุงููุฑูุฑ
const corsProxy = 'https://test.omao18193.workers.dev/';

let hls = null;

function showError(msg){
    loading.style.display='none';
    errorMsg.style.display='block';
    errorMsg.textContent=msg;
}

function buildFinalUrl(url){

    if(!url) return null;

    // ุฅุฐุง ุงูุฑุงุจุท ุฃุตูุงู ูู ุงููุฑูุฑ ูุง ุชุนูุฏ ุชุบูููู
    if(url.startsWith(corsProxy)){
        return url;
    }

    return corsProxy + '?url=' + encodeURIComponent(url);
}

function initPlayer(){

    if(!streamUrl){
        showError("ูู ูุชู ุงูุนุซูุฑ ุนูู ุฑุงุจุท ุงูููุงุฉ");
        return;
    }

    const finalUrl = buildFinalUrl(streamUrl);

    console.log("Final Stream URL:", finalUrl);

    if(Hls.isSupported()){

        hls = new Hls({
            enableWorker:true,
            lowLatencyMode:false,
            backBufferLength:90,
            maxBufferLength:60,
            maxMaxBufferLength:120,
            manifestLoadingTimeOut:20000,
            fragLoadingTimeOut:30000,
            levelLoadingTimeOut:20000,
            manifestLoadingMaxRetry:4,
            fragLoadingMaxRetry:6,
        });

        hls.attachMedia(video);

        hls.on(Hls.Events.MEDIA_ATTACHED,function(){
            hls.loadSource(finalUrl);
        });

        hls.on(Hls.Events.MANIFEST_PARSED,function(){
            video.play().then(()=>{
                loading.style.display='none';
            }).catch(()=>{
                video.muted=true;
                video.play();
                loading.style.display='none';
            });
        });

        hls.on(Hls.Events.ERROR,function(event,data){

            if(data.fatal){

                switch(data.type){

                    case Hls.ErrorTypes.NETWORK_ERROR:
                        console.log("Network error โ retrying...");
                        hls.startLoad();
                        break;

                    case Hls.ErrorTypes.MEDIA_ERROR:
                        console.log("Media error โ recovering...");
                        hls.recoverMediaError();
                        break;

                    default:
                        console.log("Fatal error โ destroying");
                        hls.destroy();
                        showError("ูุดู ุชุดุบูู ุงูููุงุฉ");
                        break;
                }
            }
        });

    }else if(video.canPlayType('application/vnd.apple.mpegurl')){

        video.src = finalUrl;

        video.addEventListener('loadedmetadata',()=>{
            video.play();
            loading.style.display='none';
        });

        video.addEventListener('error',()=>{
            showError("ูุดู ุชุดุบูู ุงูููุงุฉ");
        });
    }
}

initPlayer();

</script>
